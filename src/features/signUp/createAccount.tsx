import React, { useState, useEffect } from "react";
import { Text, TouchableOpacity, View, Modal } from "react-native";
import BouncyCheckbox from "react-native-bouncy-checkbox";
import { styled } from "nativewind";
import Icon from "react-native-vector-icons/MaterialIcons";
import TermModal from "../login/termModal";
import { auth, db } from "../../firebase";
import {
  createUserWithEmailAndPassword,
  sendEmailVerification,
  onAuthStateChanged,
} from "firebase/auth";
import EmailInput from "../../components/privateForm/emailInput";
import PasswordInput from "../../components/privateForm/passwordInput";
import { doc, getDoc, setDoc } from "firebase/firestore";
import PageBackHeader from "../../layout/header/pageBackHeader";
import { FirebaseError } from "firebase/app";
import PrivacyPolicyModal from "../login/privacyPolicyModal";
import { useSelector } from "react-redux";
import { RootState } from "../../store/store";

const StyledView = styled(View);
const StyledText = styled(Text);
const StyledTouchableOpacity = styled(TouchableOpacity);

const CreateAccount = ({
  email,
  setEmail,
  password,
  setPassword,
  passwordAgain,
  setPasswordAgain,
  isOver18,
  setIsOver18,
  isAgreeTerm,
  setIsAgreeTerm,
  isAgreePrivacyPolicy,
  setIsAgreePrivacyPolicy,
  scene,
  setScene,
  isLoading,
  setIsLoading,
}: {
  email: string;
  setEmail: React.Dispatch<React.SetStateAction<string>>;
  password: string;
  setPassword: React.Dispatch<React.SetStateAction<string>>;
  passwordAgain: string;
  setPasswordAgain: React.Dispatch<React.SetStateAction<string>>;
  isOver18: boolean;
  setIsOver18: React.Dispatch<React.SetStateAction<boolean>>;
  isAgreeTerm: boolean;
  setIsAgreeTerm: React.Dispatch<React.SetStateAction<boolean>>;
  isAgreePrivacyPolicy: boolean;
  setIsAgreePrivacyPolicy: React.Dispatch<React.SetStateAction<boolean>>;
  scene: number;
  setScene: React.Dispatch<React.SetStateAction<number>>;
  isLoading: boolean;
  setIsLoading: React.Dispatch<React.SetStateAction<boolean>>;
}) => {
  // * ############################################################################## *
  const myExpoPushToken: string | null = useSelector(
    (state: RootState) => state.myExpoPushToken.value,
  );

  const [isVisibleTermModal, setIsVisibleTermModal] = useState<boolean>(false);
  const [isVisiblePrivacyPolicyModal, setIsVisiblePrivacyPolicyModal] =
    useState<boolean>(false);
  const [
    isVisibleWaitingVerificationModal,
    setIsVisibleWaitingVerificationModal,
  ] = useState<boolean>(false);
  const [errorMessage, setErrorMessage] = useState<string>("");
  const [isSendingEmail, setIsSendingEmail] = useState<boolean>(false);
  const [timer, setTimer] = useState<number>(60);

  // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ
  function isValiedPassword(password: string) {
    const pattern = /^[A-Za-z1-9@]{6,}$/;
    return pattern.test(password);
  }

  const isValid: boolean =
    email.trim() != "" &&
    password.trim() != "" &&
    password == passwordAgain &&
    isOver18 &&
    isAgreeTerm &&
    isAgreePrivacyPolicy &&
    isValiedPassword(password);

  // „Çø„Ç§„Éû„Éº„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ
  useEffect(() => {
    let countdown: NodeJS.Timeout;
    if (isSendingEmail && timer > 0) {
      countdown = setInterval(() => {
        setTimer((prev) => prev - 1);
      }, 1000);
    } else if (timer === 0) {
      setIsSendingEmail(false);
      setTimer(60); // „Çø„Ç§„Éû„Éº„Çí„É™„Çª„ÉÉ„Éà
    }
    return () => clearInterval(countdown);
  }, [isSendingEmail, timer]);

  // „Çµ„Ç§„É≥„Ç¢„ÉÉ„ÉóÂá¶ÁêÜ
  const handleSignUp = () => {
    setIsLoading(true);
    createUserWithEmailAndPassword(auth, email, password)
      .then(async (userCredential) => {
        console.log("üéâsign up success");
        const date = new Date();
        const timestamp = date.getTime();
        handleSendEmail();
        setIsVisibleWaitingVerificationModal(true);

        // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíFirestore„Å´‰øùÂ≠ò
        const userRef = doc(db, "private", userCredential.user.uid);
        await setDoc(userRef, {
          email: email,
          password: password,
          created_at: timestamp,
          uid: userCredential.user.uid,
          expo_push_token: myExpoPushToken,
          membership_status: "free",
        });
      })
      .catch(async () => {
        // „Ç®„É©„ÉºÁô∫ÁîüÊôÇ„ÅÆÂá¶ÁêÜ
        const userRef = doc(db, "user", auth.currentUser?.uid || "");
        const userDoc = await getDoc(userRef);
        const userData = userDoc.data();

        if (userData?.email_verified) {
          console.log("Email is verified.");
          setErrorMessage("„Åô„Åß„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô");
        } else {
          console.log("Email is not verified.");
          handleSendEmail();
        }
      });
    setIsLoading(false);
  };

  // emailÈÄÅ‰ø°Âá¶ÁêÜ
  const handleSendEmail = async () => {
    setIsSendingEmail(true);
    try {
      if (auth.currentUser) {
        await sendEmailVerification(auth.currentUser);
        console.log("send email");
        // setTimeout(() => setIsSendingEmail(false), 60000); // 1ÂàÜÈñìÂÜçÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÁÑ°Âäπ„Å´„Åô„Çã
      } else {
        console.log("No user is signed in.");
      }
    } catch (error) {
      if (error instanceof FirebaseError) {
        console.error(`Firebase error: ${error.code} - ${error.message}`);
      } else {
        console.error(`Unexpected error: ${error}`);
      }
    }
  };

  // „É°„Éº„É´Ë™çË®ºÁä∂ÊÖã„ÇíÁõ£Ë¶ñ
  const handleConfirm = () => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        await user.reload(); // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Çí„É™„Éï„É¨„ÉÉ„Ç∑„É•
        if (user.emailVerified) {
          console.log("Email verified!");
          setScene((prev) => prev + 1);
          setIsVisibleWaitingVerificationModal(false);
        }
      }
    });
    return () => unsubscribe();
  };

  return (
    <StyledView>
      <StyledView className="relative h-screen w-screen bg-[#fff]">
        <PageBackHeader
          routerPage="loginPage"
          text="Êñ∞Ë¶èÁôªÈå≤"
          isFetchUserProps="true"
        />

        {/* „Éï„Ç©„Éº„É† */}
        <StyledView className="mx-auto mt-[8vh] w-[90vw] flex-1 items-center">
          <StyledView className="mb-[36px] w-full">
            <EmailInput email={email} setEmail={setEmail} option={"black"} />
          </StyledView>

          <StyledView className="mb-[20px] w-full">
            <PasswordInput
              password={password}
              setPassword={setPassword}
              option={"first"}
              isValid={isValiedPassword(password)}
            />
          </StyledView>
          <StyledView className="mb-[20px] w-full">
            <PasswordInput
              password={passwordAgain}
              setPassword={setPasswordAgain}
              option={"again"}
              isValid={passwordAgain.trim() != "" && passwordAgain == password}
            />
          </StyledView>

          <StyledView className="flex w-full gap-[22px]">
            {/* isOver18 */}
            <BouncyCheckbox
              size={25}
              fillColor="red"
              text="18Ê≠≥‰ª•‰∏ä„Åß„Åô"
              iconStyle={{ borderColor: "red" }}
              textStyle={{ textDecorationLine: "none", fontSize: 14 }}
              isChecked={isOver18}
              onPress={(isChecked: boolean) => setIsOver18(isChecked)}
            />
            {/* isAgreeTerm */}
            <StyledView className="flex h-[54px]">
              <BouncyCheckbox
                size={25}
                fillColor="red"
                text="Âà©Áî®Ë¶èÁ¥Ñ„Å´ÂêåÊÑè„Åó„Åæ„Åô"
                iconStyle={{ borderColor: "red" }}
                textStyle={{ textDecorationLine: "none", fontSize: 14 }}
                isChecked={isAgreeTerm}
                onPress={(isChecked: boolean) => setIsAgreeTerm(isChecked)}
              />
              <StyledTouchableOpacity
                onPress={() => {
                  setIsVisibleTermModal(true);
                }}
                className="absolute bottom-0 right-0"
              >
                <StyledText className="text-[12px] text-[#1d4ed8] underline">
                  Âà©Áî®Ë¶èÁ¥Ñ
                </StyledText>
              </StyledTouchableOpacity>
            </StyledView>

            {/* isAgreePrivacyPolicy */}
            <StyledView className="flex h-[54px]">
              <BouncyCheckbox
                size={25}
                fillColor="red"
                text="„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº„Å´ÂêåÊÑè„Åó„Åæ„Åô"
                iconStyle={{ borderColor: "red" }}
                textStyle={{ textDecorationLine: "none", fontSize: 14 }}
                isChecked={isAgreePrivacyPolicy}
                onPress={(isChecked: boolean) =>
                  setIsAgreePrivacyPolicy(isChecked)
                }
              />
              <StyledTouchableOpacity
                onPress={() => {
                  setIsVisiblePrivacyPolicyModal(true);
                }}
                className="absolute bottom-0 right-0"
              >
                <StyledText className="text-[12px] text-[#1d4ed8] underline">
                  „Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº
                </StyledText>
              </StyledTouchableOpacity>
            </StyledView>

            <StyledText
              className={`text-[#ff0000] ${!errorMessage && "opacity-0"}`}
            >
              {errorMessage}
            </StyledText>
          </StyledView>
        </StyledView>
      </StyledView>

      {/* Êñ∞Ë¶èÁôªÈå≤„Éú„Çø„É≥ */}
      <StyledView className="absolute bottom-[8vh] w-screen flex-1 items-center">
        <StyledView className="mx-auto mb-4 flex w-[75vw] flex-row justify-end">
          <StyledTouchableOpacity
            onPress={() => {
              handleSignUp();
              setIsVisibleWaitingVerificationModal(true);
            }}
            className={`flex h-[48px] w-[100px] items-center justify-center rounded-lg bg-[#44e25f] ${!isValid && "opacity-30"}`}
            disabled={!isValid}
          >
            <StyledText className="text-[16px] text-[#fff]">
              Êñ∞Ë¶èÁôªÈå≤
            </StyledText>
          </StyledTouchableOpacity>
        </StyledView>
      </StyledView>

      {/* „É°„Éº„É´Á¢∫Ë™çÂæÖ„Å°„É¢„Éº„ÉÄ„É´ */}
      {isVisibleWaitingVerificationModal && (
        <Modal
          animationType="slide"
          transparent={true}
          visible={isVisibleWaitingVerificationModal}
        >
          <StyledView
            className="flex-1 items-center justify-center"
            style={{ backgroundColor: "rgba(0, 0, 0, 0.5)" }}
          >
            <StyledView className="relative w-[80%] rounded-md bg-white p-[24px]">
              {/* „É¢„Éº„ÉÄ„É´„ÅÆÂè≥‰∏ä„Å´Èñâ„Åò„Çã„Éú„Çø„É≥„ÇíËøΩÂä† */}
              <StyledTouchableOpacity
                onPress={() => setIsVisibleWaitingVerificationModal(false)}
                className="absolute right-[8px] top-[8px]"
              >
                <Icon name="close" size={24} color="#f00" />
              </StyledTouchableOpacity>

              <StyledText className="mb-[16px] text-center text-lg font-bold">
                „É°„Éº„É´Á¢∫Ë™ç
              </StyledText>
              <StyledText className="mb-[24px] text-center">
                {email}
                „Å´Á¢∫Ë™ç„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´ÂÜÖ„ÅÆ„É™„É≥„ÇØ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁôªÈå≤„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
              </StyledText>

              {/* „É°„Éº„É´ÂÜçÈÄÅ‰ø°„Éú„Çø„É≥ */}
              <StyledTouchableOpacity
                onPress={() => handleSendEmail()}
                className={`mb-[12px] rounded-md bg-[#57d0e0] p-[12px] ${isSendingEmail && "opacity-70"}`}
                disabled={isSendingEmail}
              >
                <StyledText className={`text-center text-[#fff]`}>
                  {isSendingEmail
                    ? `ÂÜçÈÄÅ‰ø°ÂèØËÉΩ„Åæ„Åß ${timer} Áßí`
                    : "„É°„Éº„É´„ÇíÂÜçÈÄÅ‰ø°"}
                </StyledText>
              </StyledTouchableOpacity>

              {/* „É™„É≠„Éº„Éâ„Éú„Çø„É≥ */}
              <StyledTouchableOpacity
                onPress={() => handleConfirm()}
                className="rounded-md bg-[#44e25f] p-[12px]"
              >
                <StyledText className="text-center text-[#fff]">
                  „É°„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åó„Åü
                </StyledText>
              </StyledTouchableOpacity>
            </StyledView>
          </StyledView>
        </Modal>
      )}

      {/* Âà©Áî®Ë¶èÁ¥Ñ„É¢„Éº„ÉÄ„É´ */}
      <TermModal
        visible={isVisibleTermModal}
        onClose={() => setIsVisibleTermModal(false)}
      />
      {/* „Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº„É¢„Éº„ÉÄ„É´ */}
      <PrivacyPolicyModal
        visible={isVisiblePrivacyPolicyModal}
        onClose={() => setIsVisiblePrivacyPolicyModal(false)}
      />
    </StyledView>
  );
};

export default CreateAccount;
